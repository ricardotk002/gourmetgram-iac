apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: train-model
spec:
  entrypoint: training-and-build

  templates:
  - name: training-and-build
    steps:
      - - name: run-training
          template: run-training
      - - name: build-container
          template: trigger-build
          arguments:
            parameters:
            - name: model-version
              value: "{{steps.run-training.outputs.parameters.model-version}}"
          when: "{{steps.run-training.outputs.parameters.model-version}} != ''"

  - name: run-training
    outputs:
      parameters:
      - name: model-version
        valueFrom:
          path: /tmp/model_version
    container:
      image: registry.kube-system.svc.cluster.local:5000/gourmetgram-train:latest
      command: [python, flow.py]
      env:
        - name: MLFLOW_TRACKING_URI
          value: "http://mlflow.gourmetgram-platform.svc.cluster.local:8000"

  - name: trigger-build
    inputs:
      parameters:
      - name: model-version
    resource:
      action: create
      manifest: |
        apiVersion: argoproj.io/v1alpha1
        kind: Workflow
        metadata:
          generateName: build-container-image-
        spec:
          workflowTemplateRef:
            name: build-container-image
          arguments:
            parameters:
            - name: model-version
              value: "{{inputs.parameters.model-version}}"
